---
title: "crystalè©¦ã™ã®ã«socketã§webã‚µãƒ¼ãƒãƒ¼ã‚’æ›¸ã„ã¦ã¿ãŸ"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["crystal"]
published: false
---

### æ¦‚è¦
ãšã„ã¶ã‚“å‰ã«æŸæ‰€ã«ã¦é™çš„å‹ä»˜ã‘ãªè¨€èªã®è‰¯ã•ã«ã¤ã„ã¦~~æ´—è„³~~æ•™ãˆã‚’å—ã‘ãŸã¯ã„ã„ã‚‚ã®ã®çµå±€é™çš„å‹ä»˜ã‘ã‚„ã£ã¦ãªã„ãªã¨æ€ã£ã¦ã„ãŸã‚‰crystalãªã‚‹è¨€èªã‚’çŸ¥ã£ãŸã®è§¦ã‚Œã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸ

ã¡ã‚‡ã†ã©[ã“ã†ã„ã†è¨˜äº‹](https://qiita.com/akiray03/items/3607c60ec8b221b3c2ba)ã‚’è¦‹ã¤ã‘ãŸã®ã§rubyã®å‹‰å¼·ã«ã‚‚ãªã‚‹ã—ä¸€çŸ³äºŒé³¥ã¨ã†ã„ã†ã“ã¨ã§crystalã®socketãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§webã‚µãƒ¼ãƒãƒ¼ã‚’æ›¸ã„ã¦ã„ãã¾ã™

### TCPã‚µãƒ¼ãƒãƒ¼
ã¾ãšå…ƒã®è¨˜äº‹ã¨åŒã˜ã‚ˆã†ã«TCPã‚µãƒ¼ãƒã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã™

```rb:crystal
require "socket"

server = TCPServer.new 2000
counter : Int32 = 0
loop do
  client = server.accept
  p client
  client.puts "Hello #{Time.now} counter:#{counter}"
  client.close
  counter += 1
end
```

ã³ã£ãã‚Šã™ã‚‹ã»ã©ruby
ã›ã„ãœã„ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã«å‹ã‚’ã¤ã‘ã¦ã¿ãŸç¨‹åº¦
å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨å•é¡Œãªãå‹•ãã¾ã™

```
$ nc 127.0.0.1 2000
Hello 2018-09-02 23:08:57 +09:00 counter:0
$ nc 127.0.0.1 2000
Hello 2018-09-02 23:08:58 +09:00 counter:1
$ nc 127.0.0.1 2000
Hello 2018-09-02 23:08:59 +09:00 counter:2
```

æ¬¡ã«TCPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œç­”ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™

```rb:crystal
require "socket"

server = TCPServer.new 2000
counter : Int32 = 0
loop do
  client = server.accept
  p client
  while buffer = client.gets
    puts buffer
  end
  client.puts "Hello #{Time.now} counter:#{counter}"
  client.close
  counter += 1
end
```

ã‚„ã¯ã‚Šçµæœã‚‚åŒã˜
rubyã¨ã»ã¼åŒã˜ã‚³ãƒ¼ãƒ‰ã§å‹•ãã¾ã—ãŸ

```
$ echo "æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†" | nc 127.0.0.1 2000
Hello 2018-09-02 23:21:24 +09:00 counter:0
```
```
$ crystal src/echo.cr
#<TCPSocket:fd 8>
æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†
```

### HTTPã‚µãƒ¼ãƒãƒ¼
æœ€ä½é™ã®HTTPã‚µãƒ¼ãƒãƒ¼
ã¨ã‚Šã‚ãˆãšã¯rubyã¨åŒã˜ã‚ˆã†ã«æ›¸ã‘ã¾ã™
ãŸã ç©ºã®é…åˆ—ã®ä½œã‚Šæ–¹ã®é•ã„ã«rubyã¨ã®é•ã„ã‚’è¦‹ã¦å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã­

```rb:crystal
require "socket"

server = TCPServer.new(2000)
loop do
  socket = server.accept
  headers = Array(String).new
  while header = socket.gets
    break if header.chomp.empty?
    headers << header.chomp
  end
  p headers

  socket.puts "HTTP/1.0 200 OK"
  socket.puts "Content-Type: text/plain"
  socket.puts
  socket.puts "æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†"
  socket.close
end
```

```
$ crystal src/echo.cr
["GET / HTTP/1.1", "Host: 127.0.0.1:2000", "User-Agent: curl/7.54.0", "Accept: */*"]
```

```
$ curl -v http://127.0.0.1:2000/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 2000 (#0)
> GET / HTTP/1.1
> Host: 127.0.0.1:2000
> User-Agent: curl/7.54.0
> Accept: */*
>
* HTTP 1.0, assume close after body
< HTTP/1.0 200 OK
< Content-Type: text/plain
<
æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†
* Closing connection 0
```

ã“ã“ã¾ã§ã¯å•é¡Œãªãå‹•ãã¾ã—ãŸ
ã§ã¯ä¸¦åˆ—åŒ–ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ
è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†

```rb:crystal
require "socket"

server = TCPServer.new(2000)
loop do
  Thread.start(server.accept) do |socket|
    p [Thread.current]
    headers = Array(String).new
    while header = socket.gets
      break if header.chomp.empty?
      headers << header.chomp
    end
    p [Thread.current, headers]

    socket.puts "HTTP/1.0 200 OK"
    socket.puts "Content-Type: text/plain"
    socket.puts
    socket.puts "æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†"
    socket.close
  end
end
```

```
$ crystal src/echo.cr
Error in src/echo.cr:7: instantiating 'loop()'

  loop do
  ^~~~

in src/echo.cr:7: instantiating 'loop()'

  loop do
  ^~~~

in src/echo.cr:8: undefined method 'start' for Thread:Class

    Thread.start(server.accept) do |socket|
           ^~~~~
```

ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸ
ã©ã†ã‚„ã‚‰[crystalã§ã¯Thread.startã¯å­˜åœ¨ã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã­](https://tmtms.hatenablog.com/entry/2015/12/22/crystal)
spawnã‚’ä½¿ã†ã¨ã„ã„æ„Ÿã˜ã«ã§ãã‚‹ã‚ˆã†ãªã®ã§ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†

```rb:crystal
require "socket"

server = TCPServer.new(2000)
loop do
  socket = server.accept
  spawn do
    headers = Array(String).new
    while header = socket.gets
      break if header.chomp.empty?
      headers << header.chomp
    end
    p headers

    socket.puts "HTTP/1.0 200 OK"
    socket.puts "Content-Type: text/plain"
    socket.puts
    socket.puts "æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†"
    socket.close
  end
end
```
```
$ nc 127.0.0.1 2000
```
```
$ curl -v http://127.0.0.1:2000/
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 2000 (#0)
> GET / HTTP/1.1
> Host: 127.0.0.1:2000
> User-Agent: curl/7.54.0
> Accept: */*
>
* HTTP 1.0, assume close after body
< HTTP/1.0 200 OK
< Content-Type: text/plain
<
æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†
* Closing connection 0
```
```
$ crystal src/echo.cr
["GET / HTTP/1.1", "Host: 127.0.0.1:2000", "User-Agent: curl/7.54.0", "Accept: */*"]
```

ã†ã¾ãå‹•ä½œã—ã¾ã—ãŸã­

### ã¾ã¨ã‚
  - ã»ã¼è‡ªåˆ†ã§ã‚³ãƒ¼ãƒ‰æ›¸ã‹ãªã‹ã£ãŸã®ã§ã¯ã¨æ€ã†ãã‚‰ã„ã«å…ƒã®è¨˜äº‹ã®rubyã®ã¾ã¾ã§å‹•ã„ã¦ã—ã¾ã£ãŸ
  - ãŸã ä¸€æ–¹ã§rubyã¨ã®é•ã„ã¨ã„ã†ã®ã‚‚ã¨ã“ã‚ã©ã“ã‚è¦‹å—ã‘ã‚‰ã‚ŒãŸ
  - rubyçš„ãªæ›¸ãã‚„ã™ã•ã¨é™çš„å‹ä»˜ã‘ã®å®‰å…¨æ€§ã‚’å…¼ã­å‚™ãˆãŸä¸Šã«é€Ÿã„ã®ã¯å¼·ã„ãªã£ã¦æ€ã£ãŸ
  - å€‹äººçš„ã«ã¯å¥½ããªã®ã§æµè¡Œã£ã¦ã»ã—ã„


