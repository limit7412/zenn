---
title: "dart2nativeã§ã‚‚AWS Lambdaã®Custom Runtimeã§ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹Dartã—ã¦ã¿ãŸ"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Dart","AWS","lambda","serverless"]
published: false
---

ã©ã†ã‚‚å‰ã«[ã“ã‚“ãªè¨˜äº‹](https://qiita.com/qazx7412/items/8bda5d97614d272ed829)ã‚’æ›¸ã„ãŸè€…ã§ã™ã€‚
ã¡ã‚‡ã£ã¨Nimã‚„Kotlin/Nativeã‚’ç›¸æ‰‹ã«ã—ã¦ã„ã‚‹åˆé–“ã«[dart2native](https://dart.dev/tools/dart2native)ãªã‚‹ã‚‚ã®ãŒã§ãã¦Dartã‹ã‚‰ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªãŒä½œã‚Œã‚‹ã‚ˆã†ãªã£ã¦ã„ã¾ã—ãŸã€‚
ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã™ã‹ã‚‰cliã‚’ä½œã‚Šã‚„ã™ããªã‚Šã¾ã™ã—ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚ä»Šã¾ã§ã‚ˆã‚Šã‚‚æ¥½ã«ãªã‚Šã¾ã™ã—ã“ã‚Œã¯ã‚¨ãƒ©ã„ã“ã¨ã§ã™ã€‚
Lambdaã®ã‚ˆã†ãªæ„åœ°ã§ã‚‚å¿…è¦ãªã‚‚ã®ã‚’å…¨éƒ¨è©°ã‚è¾¼ã¾ãªã‘ã‚Œã°ãªã‚‰ãªã„ç’°å¢ƒãªã‚‰ãªãŠã•ã‚‰ã§ã™ã€‚

ã¨ã„ã†ã“ã¨ã§ã“ã®æ­£æœˆã«dart2nativeå¯¾å¿œã—ãŸã®ã§å¤‰æ›´ç‚¹ã‚’ä¸­å¿ƒã«ç°¡å˜ã«ã¾ã¨ã‚ç›´ã—ã¾ã™ã€‚
æ¯åº¦ã®ã“ã¨ã§ã™ãŒæœ€çµ‚çš„ãªæˆæœç‰©ã¯[ã“ã¡ã‚‰](https://github.com/limit7412/lambda_dart_sls)ã«ãŠã„ã¦ã‚ã‚Šã¾ã™ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ã¾ãšãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
å‰å›ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚·ã‚§ãƒ«ã¨ã—ã¦ã¯ãã‚Œãªã‚Šã«è¤‡é›‘ã ã£ãŸã®ã«å¯¾ã—ã¦ã‹ãªã‚Šå˜ç´”ãªä½œã‚Šã ã¨æ€ã„ã¾ã™ã€‚
ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å˜ç´”ã§ã™ã€‚
Custom Runtimeã§ã¯Lambdaã®èµ·å‹•æ™‚ã« `./bootstrap` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§dart2nativeã§åŒåã®ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
dockerã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã¯ä»Šã®æ‰€dart2nativeãŒã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æœªå¯¾å¿œãªã®ã§linuxï¼ˆã™ãªã‚ã¡Lamdbaï¼‰ã§å‹•ã‹ã›ã‚‹ãƒã‚¤ãƒŠãƒªã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ã£ã¦ã„ã¾ã™ã€‚
ãŸã ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‘¨ã‚Šã‚’ã†ã¾ã„ã“ã¨å‡¦ç†ã§ããªã‹ã£ãŸã®ã§ãƒ“ãƒ«ãƒ‰å‰ã« `pub get` ã‚’ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã§å¼·å¼•ã«ã™ã‚‹ã“ã¨ã§è§£æ±ºã—ã¦ã„ã¾ã™ã€‚
æœ¬å½“ã¯ã‚‚ã†å°‘ã—ã‚¹ãƒãƒ¼ãƒˆãªè§£æ±ºæ–¹æ³•ã‚‚ã‚ã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ã¨ã¯æ€ã„ã¾ã™ãŒã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªãŒæ¥ãŸãªã‚‰ã©ã†ã›ã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¯ã„ã¤ã‹è§£æ±ºã™ã‚‹ã‚“ã§ã—ã‚‡ã†ã—ã“ã“ã§é ‘å¼µã£ã¦ã‚‚å¾Œã§æ„å‘³ãŒç„¡ããªã‚Šãã†ã ãªã£ã¦æ€ã£ã¦ã—ã¾ã£ãŸã®ã§ã“ã‚Œã§ãŠè¨±ã—ã„ãŸã ããŸã„â€¦

```sh:deploy.sh
rm -rf ./bootstrap
pub get || exit 1

# TODO: change use cross compile
sudo docker run --rm -v $(pwd):/work -w /work google/dart bash -c "pub get && dart2native ./src/main.dart -o ./bootstrap" &&
sudo chmod 755 ./bootstrap || exit 1

sls deploy -s $stg &&
pub get
```

## ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
ã•ã¦ã§ã¯æ¬¡ã¯Dartã®ã‚³ãƒ¼ãƒ‰ã®æ–¹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
å‰å›ã¯ `./src/handler/hoge.dart` ã¿ãŸã„ãªhandlerã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã‚Œãã‚Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ã„ã†æ–¹å¼ã‚’ã¨ã£ã¦ã„ã¾ã—ãŸãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¦‹ã¦é ‚ã„ãŸé€šã‚Šã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã‚’1ã¤ã ã‘å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã®ã§ãã‚Œã«ä¼´ã„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ§‹é€ ã‚‚å¤‰æ›´ã—ã¾ã—ãŸã€‚

ã§ã¯ã¾ãšdart2nativeã§æŒ‡å®šã—ã¦ã„ã‚‹ `./src/main.dart` ã¨ãã®ä¸­ã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æŒ¯ã‚‹èˆã„ã‚’å®šç¾©ã™ã‚‹ `serverless.yml` ã§ã™ã€‚

```dart:main.dart
import 'dart:convert';
import './runtime.dart';

void main() {
  lambdaHandler("hello", (event) async {
    return {
      'statusCode': 200,
      'body': json.encode({'msg': 'æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†ã€‚'}),
    };
  });

  lambdaHandler("world", (event) async {
    final body = event['body'];
    return {
      'statusCode': 200,
      'body': body,
    };
  });
}
```

```yml:serverless.yml
functions:
  hello:
    handler: hello
    events:
      - http:
          path: hello
          method: get
  world:
    handler: world
    events:
      - http:
          path: world
          method: post
```

serverless.ymlã¯å‰å›ã¨ã»ã¼åŒã˜ã§ã™ã€‚ï¼ˆã¤ã„ã§ã«ãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãŸã‚Šã—ã¾ã™ãŒâ€¦ï¼‰
`<url>/hello` ã¸getã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã™ã‚‹ã¨helloãŒã€`<url>/world` ã¸postã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã™ã‚‹ã¨worldãŒå‹•ä½œã—ã¾ã™ã€‚
ä¸€æ–¹ã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ã¯callbackã®ä»–ã«å¼•æ•°ãŒ1ã¤å¢—ãˆã¦ã„ã¾ã™ã€‚
å‰å›ã¯å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãã‚Œãã‚Œåˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã„ãŸã®ã§ä¸è¦ã§ã—ãŸãŒä»Šå›ã¯åŒã˜mainé–¢æ•°å†…ã«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒè¨˜è¿°ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã©ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå‹•ãã®ã‹æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«å¢—ã‚„ã—ã¾ã—ãŸã€‚
ã“ã‚Œã®ä»•çµ„ã¿ã¯ç’°å¢ƒå¤‰æ•° `_HANDLER` ã«serverless.ymlã§æŒ‡å®šã—ãŸæ–‡å­—åˆ—ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’åˆ©ç”¨ã—ã¦åˆ¤å®šã€é•ã£ãŸã‚‰æ—©æœŸreturnã‚’ã™ã‚‹ã¨ã„ã†æ¥µã‚ã¦å˜ç´”ãªã‚‚ã®ã§ã™ã€‚

```dart:runtime.dart
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:io' show Platform;

void lambdaHandler(String name, Function callback) async {
  if (name != Platform.environment['_HANDLER']) {
    return;
  }

  final api = Platform.environment['AWS_LAMBDA_RUNTIME_API'];

  while (true) {
    final response =
        await http.get('http://${api}/2018-06-01/runtime/invocation/next');

    final event_data = json.decode(utf8.decode(response.bodyBytes));
    final request_id = response.headers['lambda-runtime-aws-request-id'];

    try {
      final result = await callback(event_data);
      http.post(
          'http://${api}/2018-06-01/runtime/invocation/${request_id}/response',
          body: json.encode(result));
    } catch (e) {
      http.post(
          'http://${api}/2018-06-01/runtime/invocation/${request_id}/error',
          body: json.encode({
            'statusCode': 500,
            'body': json.encode({'msg': 'Internal Lambda Error'}),
          }));
    }
  }
}
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚Œã°å‰å›ã¨åŒã˜çµæœãŒå¸°ã£ã¦ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚

```
$ ./deploy.sh
ï¼ˆç•¥ï¼‰
Service Information
service: serverless-dart-sls
stage: dev
region: ap-northeast-1
stack: serverless-dart-sls-dev
resources: 17
api keys:
  None
endpoints:
  GET - https://hoge.execute-api.ap-northeast-1.amazonaws.com/dev/hello
  POST - https://hoge.execute-api.ap-northeast-1.amazonaws.com/dev/world
functions:
  hello: serverless-dart-sls-dev-hello
  world: serverless-dart-sls-dev-world
layers:
  None
Serverless: Removing old service artifacts from S3...
Serverless: Run the "serverless" command to setup monitoring, troubleshooting and testing.
Resolving dependencies...
Got dependencies!

$ curl https://hoge.execute-api.ap-northeast-1.amazonaws.com/dev/hello
{"msg":"æ–°ãŸãªå…‰ã«ä¼šã„ã«è¡Œã“ã†ã€‚"}

$ curl -X POST -H "Content-Type: application/json" -d '{"msg": "å¤§çŸ³æ³‰ã™ã"}' \
  https://hoge.execute-api.ap-northeast-1.amazonaws.com/dev/world
{"msg": "å¤§çŸ³æ³‰ã™ã"}
```

## ã¾ã¨ã‚
ã¨ã„ã†ã“ã¨ã§é§†ã‘è¶³ã§ã—ãŸãŒdart2nativeã§ã‚‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§ãã¾ã—ãŸã€‚
dart2nativeã€è§¦ã£ã¦ã¿ãŸæ„Ÿã˜ã‚„ã¯ã‚Šã‚¯ãƒ­ã‚¹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ããªã„ã®ã¯ã¡ã‚‡ã£ã¨ã¤ã‚‰ã„ã§ã™ãŒæ‚ªãã¯ãªã„ã§ã™ã­ã€‚
Goã‚‚ãã†ã§ã™ãŒGoogleã®ä½œã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã£ã¦æ–‡æ³•ã¯ä¿å®ˆçš„ã§ã™ã‘ã©è¶³å›ã‚Šã¯ã‚ã¡ã‚ƒãã¡ã‚ƒè‰¯ã„ã¿ãŸã„ãªã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ã­ã€‚
ç¾åœ¨1ç•ªæ‰‹ã®Goã¯ã¨ã‚‚ã‹ãNimã‚„crystalã€Kotlin/Nativeã¿ãŸã„ãªGCã‚ã‚Šã®ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªå‡ºåŠ›è¨€èªçš„ã«ã¯æ‰‹å¼·ã„ãƒ©ã‚¤ãƒãƒ«ã ã¨æ€ã„ã¾ã™ã€‚
ï¼ˆã¨ã“ã‚ã§[ç›´è¿‘ã®è¨˜äº‹](https://qiita.com/qazx7412/items/76c1dcd173bdfa07b570)ã§Custom Runtimeã®è¨˜äº‹ã‚’æ›¸ãäººã¯è„±å´ã—ãŸã„ã¨ã‹è¨€ã„ã¤ã¤çµå±€Custom Runtimeã®è¨˜äº‹æ›¸ã„ã¦ã‚‹ãªâ€¦ï¼‰
