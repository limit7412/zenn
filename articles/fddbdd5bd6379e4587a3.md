---
title: "Serverless Frameworkã§Custom RuntimeãªLambdaã‚’ã‚³ãƒ³ãƒ†ãƒŠå¯¾å¿œã™ã‚‹"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["lambda", "aws", "serverless", "githubactions"]
published: false
---

ServerlessãŒ[Lambdaã®ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã«å¯¾å¿œã—ã¦ã„ãŸ](https://www.serverless.com/blog/container-support-for-lambda)ã‚ˆã†ãªã®ã§æ—©é€Ÿè©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
ä»Šå›ã¯è¨˜äº‹ä¸­ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯è¨€èªã¯Crystalã€è¡¨é¡Œã®é€šã‚ŠCustom Runtimeã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ãŒä»–ã®ç’°å¢ƒã§ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚
ã¾ãŸä»Šå›ã¯è¨€èªã¨ã—ã¦Custom Runtimeã‚’ä½¿ç”¨ã™ã‚‹ã®ã«å¿…è¦ãªå®Ÿè£…ã«ã¤ã„ã¦ã¯ç‰¹ã«è§£èª¬ã—ã¾ã›ã‚“ã®ã§ã€ã‚‚ã—å¿…è¦ãªå ´åˆã¯[ã“ã¡ã‚‰](https://qiita.com/qazx7412)ã‹ã‚‰éå»ã®è¨˜äº‹ã‚’ã‚’å‚ç…§ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚
ã„ãã¤ã‹ã®è¨€èªã§ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚ˆã†ã„ã—ã¦ã„ã‚‹ã®ã§ä¸‹è¨˜ã‚‚å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
  - [Crystal](https://github.com/limit7412/lambda-crystal-sls)
  - [nim](https://github.com/limit7412/lambda-nim-sls)
  - [Dart](https://github.com/limit7412/lambda_dart_sls)

## Serverlessã§ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•
ã¨ã‚Šã‚ãˆãšå‹•ã‹ã—ã¦ã¿ã‚‹ã ã‘ãªã‚‰ç‰¹ã«é›£ã—ãã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ä¸‹è¨˜ã®ä¾‹ï¼ˆ[Serverlessã®å…¬å¼ã®ç´¹ä»‹è¨˜äº‹ã‚ˆã‚Šæ‹å€Ÿ](https://www.serverless.com/blog/container-support-for-lambda)ï¼‰ã®ã‚ˆã†ã«ã€ä»Šã¾ã§serverless.ymlã§æŒ‡å®šã—ã¦ã„ãŸhandlerã®ä»£ã‚ã‚Šã«imageã¨ã„ã†é …ç›®åã§ECRä¸Šã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹ä½¿ç”¨ã—ãŸã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®URIã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã™ã€‚
ä¸€å¿œæ³¨æ„ç‚¹ã¨ã—ã¦ã€ã‚¿ã‚°ãªã©ã§ã¯ãªãå¿…ãšdigestã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml
functions:
  someFunction:
    image: <account>.dkr.ecr.<region>.amazonaws.com/<repository>@<digest>
```

ã¤ã¾ã‚Šå®Ÿè·µã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‰æº–å‚™ã¨ã—ã¦ã€Œã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ECRã¸ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹å‡¦ç†ã€ã¨ã€Œãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã€ãŒå¿…è¦ã«ãªã‚‹ã¨ã„ã†ã“ã¨ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ECRã¸ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
å…ã«ã‚‚è§’ã«ã‚‚ã¾ãšECRã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ãªãã¦ã¯ãªã«ã‚‚å§‹ã¾ã‚Šã¾ã›ã‚“ã€‚
ã¨ã„ã†ã“ã¨ã§Crystalã®å ´åˆã®Dockerfileã®ä¾‹ã‚’è²¼ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```Dockerfile
FROM crystallang/crystal:latest as build-image

WORKDIR /work
COPY ./ ./

RUN crystal build --link-flags -static -o bootstrap src/main.cr
RUN chmod +x bootstrap

FROM public.ecr.aws/lambda/provided:al2

COPY --from=build-image /work/ /var/runtime/

# NOTE: ã“ã“ã§æŒ‡å®šã—ãŸæ–‡å­—åˆ—ãŒhandlerã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹
CMD ["hello"]
```

ã¿ã¦ã„ãŸã ã‘ã‚Œã°åˆ†ã‹ã‚‹é€šã‚Šã€ãã‚“ãªã«é›£ã—ã„ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
Crystalã®å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’ã—ã¾ã™ã€‚
Custom Runtimeã®å ´åˆã¯ `/var/runtime/bootstrap` ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ãƒ“ãƒ«ãƒ‰ã—ãŸãƒã‚¤ãƒŠãƒªã‚’AWSãŒå…¬å¼ã§é…å¸ƒã—ã¦ã„ã‚‹Lambdaç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¸ã‚³ãƒ”ãƒ¼ã™ã‚‹ã ã‘ã§ã™ã€‚
ã“ã“ã§1ç‚¹æ³¨æ„ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã¯ã€Lambdaã«ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯å¿…ãšAWSã®å…¬å¼ã®Lambdaç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãªãã¦ã¯ãªã‚‰ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã“ã®ä¾‹ã®å ´åˆã¯Custom Runtimeç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã®ã§ã™ãŒã€ã¾ãšECRã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã®ãƒªãƒã‚¸ãƒˆãƒªãŒå¿…è¦ã§ã™ã€‚
aws cliã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚

```shell
$ aws ecr create-repository --repository-name <ãƒªãƒã‚¸ãƒˆãƒªå> --image-scanning-configuration scanOnPush=true
```

ãã†ã—ãŸã‚‰æ¬¡ã¯ECRã¸ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```shell
$ aws ecr get-login-password --region <ãƒªãƒ¼ã‚¸ãƒ§ãƒ³>                                               |
$ docker login --username AWS --password-stdin <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³>.amazonaws.com
```

å‚è€ƒã¨ã—ã¦ã€AWSã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã™ã‚‹ã¨è‡ªå‹•ã§å–å¾—ã§ãã¾ã™ã€‚
```shell
$ aws sts get-caller-identity | jq -r .Account
```

ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ãŸã‚‰ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥ãŒå‡ºæ¥ã¾ã™ã€‚
```shell
$ docker build -t <ã‚³ãƒ³ãƒ†ãƒŠå> .
$ docker tag <ã‚³ãƒ³ãƒ†ãƒŠå>:<ã‚¿ã‚°å> <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.ap-northeast-1.amazonaws.com/<ã‚³ãƒ³ãƒ†ãƒŠå>:<ã‚¿ã‚°å>
$ docker push <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>.dkr.ecr.ap-northeast-1.amazonaws.com/<ã‚³ãƒ³ãƒ†ãƒŠå>:<ã‚¿ã‚°å>
```

## ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
æ¬¡ã«å‰ç« ã§ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã‚’å–å¾—ã—ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦Serverlessã§Lambdaã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
å‰æã¨ã—ã¦ã€serverless.ymlã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰å€¤ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```yaml
custom:
  # NOTE: sls removeãªã©ã‚’å®Ÿè¡Œã™ã‚‹ã®ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã›ãšå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®
  defaultAccount: dummy
  defaultDigest: dummy

functions:
  hello:
    image: ${opt:account, self:custom.defaultAccount}.dkr.ecr.<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³>.<ã‚³ãƒ³ãƒ†ãƒŠå>@${opt:digest, self:custom.defaultDigest}
    events:
      - http:
          path: test
          method: get
```

ã¨ã„ã†ã“ã¨ã§Serverlessã¸å¼•ãæ¸¡ã™ãŸã‚ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ãã¾ã™ã€‚
ã¾ãšå‰è¿°ã®é€šã‚Šã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¯ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§å–å¾—å‡ºæ¥ã¾ã™ã€‚
```shell
$ aws sts get-caller-identity | jq -r .Account
```

ãã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã®digestã§ã™ãŒã€aws-cliã‚’åˆ©ç”¨ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã®ä¸€è¦§ã‚’å–å¾—ã§ãã‚‹ã®ã§jqã‚’ä½¿ã£ã¦ä½¿ã„ãŸã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°åˆ©ç”¨ã—ã¦ã‚’çµã‚Šè¾¼ã‚“ã§ã‚„ã‚‹ã¨digestãŒå–å¾—å‡ºæ¥ã¾ã™ã€‚
```shell
$ aws ecr list-images --repository-name <ã‚³ãƒ³ãƒ†ãƒŠå>               |
$ jq '.imageIds[] | select(.imageTag=="<ã‚¿ã‚°å>") | .imageDigest' |
$ tr -d '"'
```

ã‚ã¨ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«å–å¾—ã—ãŸå€¤ã‚’Serverlessã¸å¼•ãæ¸¡ã—ã¦ã‚„ã‚Œã°ãƒ‡ãƒ—ãƒ­ã‚¤å‡ºæ¥ã¾ã™ã€‚
```shell
$ sls deploy --account <ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID> --digest <digest>
```

ã“ã“ã¾ã§ã®ä¸€é€£ã®æµã‚Œã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¾ã¨ã‚ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚
```bash
region="ap-northeast-1"

account=$(aws sts get-caller-identity | jq -r .Account)
tag=$(uuidgen)

aws ecr get-login-password --region $region                                         |
docker login --username AWS --password-stdin $account.dkr.ecr.$region.amazonaws.com

container="lambda_container_sample"
target="$account.dkr.ecr.ap-northeast-1.amazonaws.com/$container"

docker build -t $container .
docker tag $container:$tag $target:$tag
docker push $target:$tag

digest=$(aws ecr list-images --repository-name $container | jq '.imageIds[] | select(.imageTag=="latest") | .imageDigest' | tr -d '"')

sls deploy --account $account --digest $digest
```

## ã¾ã¨ã‚
ã¨ã„ã†ã‚ã‘ã§Custom Runtimeãªç’°å¢ƒã§ã®Serverless Frameworkã®ã‚³ãƒ³ãƒ†ãƒŠå¯¾å¿œã®ç´¹ä»‹ã§ã—ãŸã€‚
æ­£ç›´ãªã¨ã“ã‚è§¦ã£ã¦ã¿ãŸæ„Ÿã˜ã¾ã ã¨ã‚Šã‚ãˆãšå¯¾å¿œã—ã¾ã—ãŸã¨ã„ã†æ„Ÿã˜ã§ã“ã‚Œã‹ã‚‰ä¾¿åˆ©ä½¿ãˆã‚‹ã‚ˆã†ã«æ”¹å–„ã•ã‚Œã¦ã„ãã®ã‹ãªï¼Ÿã¨ã„ã†æ„Ÿã˜ã§ã™ã­ã€‚
å°‘ãªãã¨ã‚‚ä»Šå›ä¾‹ã«å‡ºã—ãŸCrystalã‚„å…¬å¼å¯¾å¿œã—ã¦ã‚‹è¨€èªã§ã¯Goãªã‚“ã‹ã®å¯æ¬æ€§ã®é«˜ã„ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã‚’ä½œã‚Œã‚‹è¨€èªã®å ´åˆãªã‚“ã‹ã§ã¯ä»Šã™ãé£›ã³ã¤ã„ã¦å¯¾å¿œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã¨ã„ã†ã¨å¾®å¦™ãªæ„Ÿã˜ã§ã™ã€‚
é€†ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªã¨ã‹ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ã¦å‰æº–å‚™ã¨ã‹ã‚’ã—ãŸã„ãªã‚‰ä½¿ã£ã¦ã‚‚ã„ã„ã‹ã‚‚ã§ã™ã­ã€‚
å…ˆç¨‹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã‚“ã‹ã‚’ã¿ã¦ã‚‚ã‚‰ãˆã‚Œã°ã‚ã‹ã‚‹é€šã‚Šã€æ­£ç›´ãã‚“ãªã«é›£ã—ã„ã“ã¨ã¯ã—ã¦ã„ãªã„ã®ã§è¿‘ã„ã†ã¡ã«ãƒ­ãƒ¼ã‚«ãƒ«ã®Dockerfileã‚’è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹æ°—ã¯ã—ã¦ã„ã¾ã™ã€‚

## ãŠã¾ã‘
Github Actionsç”¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®workflowsã‚’ä½œã£ãŸã®ã§è¼‰ã›ã¦ãŠãã¾ã™ã€‚
ã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

```yaml
name: lambda_container_sample

on:
  push:
    branches: [ develop ]

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    steps:

    - name: setup node.js
      uses: actions/setup-node@v1

    - name: install sls
      run: npm i -g serverless

    - name: checkout
      uses: actions/checkout@v1

    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    - name: login ecr
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@master

    - name: build and push ecr
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: lambda_container_sample
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    - name: get aws account id
      id: get-aws-account
      run: |
        echo "::set-output name=ACCOUNT_ID::$(aws sts get-caller-identity | jq -r .Account)"

    - name: get ecr digest
      id: get-ecr-digest
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "::set-output name=DIGEST::$(aws ecr list-images --repository-name lambda_container_sample | jq '.imageIds[] | select(.imageTag=="'$IMAGE_TAG'") | .imageDigest' | tr -d '"')"

    - name: deploy
      env:
        ACCOUNT_ID: ${{ steps.get-aws-account.outputs.ACCOUNT_ID }}
        DIGEST: ${{ steps.get-ecr-digest.outputs.DIGEST }}
      run: sls deploy --verbose --account $ACCOUNT_ID --digest $DIGEST
```
